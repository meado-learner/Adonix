import yts from 'yt-search';
import fetch from 'node-fetch';

async function getRandomCDN() {
  const res = await fetch('https://media.savetube.me/api/random-cdn');
  const data = await res.json();
  return data.cdn; 
}

async function getVideoDownload(videoId, format = 'mp4', quality = '720p') {
  const cdn = await getRandomCDN();
  const convertUrl = `https://${cdn}/api/convert`;

  const res = await fetch(convertUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ videoId, format, quality })
  });

  const data = await res.json();
  if (!data.downloadUrl) throw new Error('No se pudo obtener el link de descarga');
  return data.downloadUrl;
}

let handler = async (m, { conn, command, text, usedPrefix }) => {
  if (!text) 
    return conn.reply(m.chat, '„Äå‚úø„Äç Ingresa el nombre de lo que quieres buscar', m);

  await m.react('üïì');

  let res = await yts(text);
  let play = res.videos[0];

  if (!play) 
    return conn.reply(m.chat, '> No se encontraron resultados para tu b√∫squeda', m);

  let { title, thumbnail, ago, timestamp, views, videoId, url, author } = play;

  let txt = '';
  txt += `„Äå‚ú¶„Äç Descargando *${title || ''}*\n\n`;
  txt += `> ‚ùë Canal ¬ª *${author.name || ''}*\n`;
  txt += `> ‚ô° Vistas ¬ª *${views.toLocaleString() || ''}*\n`;
  txt += `> ‚úßÔ∏é Duraci√≥n ¬ª *${timestamp || ''}*\n`;
  txt += `> ‚úø Publicado ¬ª *${ago || ''}*\n`;
  txt += `> ‚úé Link ¬ª https://youtube.com/watch?v=${videoId}`;

  let thumbnailBuffer;
  try {
    const resFetch = await fetch(thumbnail);
    thumbnailBuffer = await resFetch.buffer();
  } catch {
    thumbnailBuffer = null;
  }

  await conn.sendMessage(
    m.chat,
    {
      text: txt,
      footer: 'YouTube',
      mentions: [m.sender],
      contextInfo: {
        externalAdReply: {
          title: botname || 'Video',
          body: global.author || '',
          mediaType: 1,
          mediaUrl: url,
          sourceUrl: url,
          thumbnail: thumbnailBuffer,
          containsAutoReply: true,
          renderLargerThumbnail: true
        }
      }
    },
    { quoted: m }
  );

  try {
    if (command === 'play' || command === 'play2') {
      if (command.endsWith('mp3') || command === 'play') {
        
        const audioUrl = await getVideoDownload(videoId, 'mp3');
        await conn.sendMessage(m.chat, { 
          audio: { url: audioUrl }, 
          mimetype: 'audio/mpeg', 
          ptt: false 
        }, { quoted: m });
      } else {
    
        const videoUrl = await getVideoDownload(videoId, 'mp4');
        await conn.sendMessage(m.chat, { 
          video: { url: videoUrl }, 
          caption: `„Äå‚ú¶„Äç *${title}*`,
        }, { quoted: m });
      }
    }
    await m.react('‚úÖ');
  } catch (e) {
    console.log(e);
    conn.reply(m.chat, '„Äå‚ùå„Äç Ocurri√≥ un error al descargar', m);
  }
};

handler.help = ['play', 'play2'];
handler.tags = ['descargas'];
handler.command = ['play', 'play2'];

export default handler;
